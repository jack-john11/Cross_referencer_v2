# Story 1.5: Implement File Upload UI

## Story Information
- **Epic**: 1.4 - Project File Management & Document Upload
- **Story Number**: 1.4.1
- **Title**: Implement File Upload UI
- **Status**: Done

## Story
As an ecological consultant, I want to easily upload my source documents to a project, so that I can begin the process of data extraction and analysis.

## Acceptance Criteria
1.  **AC1**: On the Project Details page (`/projects/[id]`), a dedicated section for "Source Documents" is visible.
2.  **AC2**: This section contains a file dropzone component (`FileDropzone`) that allows users to either drag and drop files or click to open a file selection dialog.
3.  **AC3**: The dropzone clearly indicates the accepted file types (e.g., PDF, XLSX, DOCX, JPG, PNG).
4.  **AC4**: When files are selected, the UI displays a list of files to be uploaded, showing their name and size.
5.  **AC5**: A main "Upload" button is present and is disabled until at least one valid file is selected.
6.  **AC6**: Clicking "Upload" initiates the upload process for all selected files and shows a progress indicator (e.g., a progress bar or spinner) for each file.
7.  **AC7**: The UI provides clear feedback for both successful uploads and any validation errors (e.g., file too large, wrong file type).

## Dev Notes

### UI/UX
- A new `Card` component has been added to the `ProjectPage` to house the file upload functionality.
- We have reused and enhanced the existing `FileDropzone` component from `apps/web/components/ui/file-dropzone.tsx`.
- The UI handles multiple file selections gracefully. The list of staged files is displayed within the card before the user commits to uploading them.
- `lucide-react` icons like `UploadCloud`, `File`, and `X` are used for the UI.

### State Management
- A new slice of actions and state has been added to the `FileManagementStore` (`apps/web/lib/stores/file-management.ts`) to manage the state of the upload process.
- This includes:
  - `stagedFiles`: An array of `File` objects selected by the user.
  - `uploadProgress`: A map to track the upload percentage for each file.
  - `isUploading`: A boolean to indicate if an upload is in progress.
- The `uploadFiles` action calls a new method in the `FileUploadService`.

### API and Services
- The story focused on the UI implementation. The actual upload logic will be handled in the next story (1.6).
- A mock `upload` method has been added to the `FileUploadService` (`apps/web/lib/services/file-upload.ts`) that simulates an upload process to allow for UI development and testing.

### File Locations
- **Modified Page**: `apps/web/app/(authenticated)/projects/[id]/page.tsx`
- **Modified Component**: `apps/web/components/ui/file-dropzone.tsx`
- **New Component**: `apps/web/components/features/file-management/file-uploader.tsx`
- **New/Modified Store**: `apps/web/lib/stores/file-management.ts`
- **New/Modified Service**: `apps/web/lib/services/file-upload.ts`
- **New Test File**: `apps/web/components/features/file-management/file-uploader.test.tsx`

### Testing Requirements
- **Unit Tests**:
  - Tests have been written to ensure the file dropzone renders correctly.
  - Tests verify that selecting files updates the UI and enables the "Upload" button.
  - Tests cover the removal of a file from the staged list.
  - The upload service is mocked to test that progress indicators and success/error messages are displayed correctly during a simulated upload.

## Tasks / Subtasks

### Task 1: Create File Uploader Component
- [x] Create a new component, `FileUploader`, in `apps/web/components/features/file-management/`.
- [x] This component contains the `FileDropzone` and the logic for displaying staged files and upload progress.
- [x] It is designed to be placed within a `Card` on the project details page.

### Task 2: Update File Management Store
- [x] In `apps/web/lib/stores/file-management.ts`, add state properties for `stagedFiles`, `uploadProgress`, and `isUploading`.
- [x] Create actions to `addStagedFile`, `removeStagedFile`, `clearStagedFiles`, and a main `uploadStagedFiles` action.

### Task 3: Implement Mock Upload Service
- [x] In `apps/web/lib/services/file-upload.ts`, create a mock `upload` function.
- [x] This function accepts a file and a progress callback. It uses `setTimeout` to simulate an upload, calling the progress callback periodically before resolving.

### Task 4: Integrate into Project Details Page
- [x] In `apps/web/app/(authenticated)/projects/[id]/page.tsx`, add a new `Card` titled "Source Documents".
- [x] Place the new `FileUploader` component inside this card and connect it to the `FileManagementStore`.

### Task 5: Write Unit Tests
- [x] Create unit tests for the `FileUploader` component.
- [x] Mock the `FileManagementStore` and `FileUploadService` to test all UI states: selecting files, uploading, progress, success, and error.
