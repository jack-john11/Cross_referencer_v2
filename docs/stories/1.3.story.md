# Story 1.3: Handle Project Update Logic

## Story Information
- **Epic**: 1.2 - Project Editing and Details Management
- **Story Number**: 1.2.2
- **Title**: Handle Project Update Logic
- **Status**: Draft

## Story
As an ecological consultant, I want to submit the edit form to update a project's information, so that the changes are saved and reflected across the application.

## Acceptance Criteria
1.  **AC1**: The "Save Changes" button on the project edit page (`/projects/[id]/edit`) is enabled only when the form is valid and there are changes.
2.  **AC2**: On form submission, the `updateProject` action from the `ProjectManagementStore` is called with the project ID and the updated form data.
3.  **AC3**: While the update is in progress, a loading indicator is displayed on the "Save Changes" button, and the form fields are disabled.
4.  **AC4**: Upon a successful update, the user is shown a success toast notification (e.g., "Project updated successfully").
5.  **AC5**: After a successful update, the user is automatically redirected back to the project details page (`/projects/[id]`), where the updated information is visible.
6.  **AC6**: If the update fails, an error toast notification is displayed with a relevant error message, and the form remains editable.

## Dev Notes

### Previous Story Insights
- This story directly follows Story 1.2, which set up the edit form UI. This story will wire up that form to the application's state and logic.
- The implementation will be very similar to the `onSubmit` handler in the `CreateProjectPage`.

### Data Models
- The story uses the `ProjectUpdateInput` type, which is derived from the `ProjectUpdateSchema` Zod validator.
  - **Schema Source**: `packages/shared-types/src/database/project-schema.ts`

### API Specifications
- This story will trigger a call to the existing backend API endpoint for updating projects. The interaction is managed through the Zustand store.
  - **Endpoint**: `PUT /api/projects/{id}`
  - **Request Body**: `UpdateProjectRequest` (defined in `packages/shared-types/src/api/project-types.ts`)
  - **State Management Action**: `updateProject(projectId, data)` in `apps/web/lib/stores/project-management.ts`

### Component Specifications
- **Project Edit Form**: The logic will be added to the `EditProjectPage` created in the previous story.
  - The `handleSubmit` function from `react-hook-form` will be implemented to orchestrate the update process.
  - The `isSubmitting` state will be used to control the UI during the update.
- **Toast Notifications**: The existing `useToast` hook will be used to provide user feedback.

### File Locations
- **Modified Page**: `apps/web/app/(authenticated)/projects/[id]/edit/page.tsx`
- **Modified Test File**: `apps/web/app/(authenticated)/projects/[id]/edit/page.test.tsx`

### Testing Requirements
- **Unit Tests**:
    - Verify that the `updateProject` store action is called with the correct data when the form is submitted.
    - Mock a successful API response and test that the success toast is shown and the user is redirected.
    - Mock a failed API response and test that the error toast is shown and the form remains active.
    - Test that the "Save Changes" button's disabled state updates correctly based on form validity and dirty state.

## Tasks / Subtasks

### Task 1: Implement Form Submission Logic (AC: 2, 3)
- [ ] In `apps/web/app/(authenticated)/projects/[id]/edit/page.tsx`, create an `onSubmit` handler function.
- [ ] Inside the handler, call the `updateProject` action from the `useProjectManagementStore`, passing the `projectId` and the form `data`.
- [ ] Implement a `isSubmitting` state to disable the form and show a loading spinner on the submit button during the API call.

### Task 2: Implement User Feedback and Navigation (AC: 4, 5, 6)
- [ ] In the `try...catch` block of the `onSubmit` handler, use the `toast` function to show a success message upon successful update.
- [ ] On success, use the `useRouter` hook to navigate the user back to the project details page (`/projects/[id]`).
- [ ] In the `catch` block, show a destructive toast with the error message if the update fails.

### Task 3: Refine Button State and Form Behavior (AC: 1)
- [ ] Update the `disabled` prop of the "Save Changes" button to be true if `!isDirty || !isValid || isSubmitting`.
- [ ] Change the button text from "Create" to "Save Changes".

### Task 4: Update Unit Tests (AC: 1, 2, 3, 4, 5, 6)
- [ ] In `apps/web/app/(authenticated)/projects/[id]/edit/page.test.tsx`, add tests for the new submission logic.
- [ ] Mock the `updateProject` action from the store to simulate success and failure scenarios.
- [ ] Assert that the correct toast messages are displayed and that navigation occurs as expected.
